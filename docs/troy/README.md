# Troy's main README for things in this repo


## Test module locally, using mock input

```bash
cd classifier
```

```python
import fastavro
import warnings

from broker_utils import gcp_utils

import main
import mock_input as mock


# get mock input
args = mock.input(max_messages=1000)

# test the main steps of main.run()
topic = "class-loop"  # we will publish module results here
# suppress FutureWarning logs generated by the supernnova library/package
# so we can easily see any logs our code produces
with warnings.catch_warnings():
    warnings.simplefilter("ignore", category=FutureWarning)
    for (alert_dict, attrs) in args:
        # alert_dict, attrs = next(args)
        snn_dict = main._classify_with_snn(alert_dict)
        avro = main._create_elasticc_msg(dict(alert=alert_dict, SuperNNova=snn_dict), attrs)
        gcp_utils.publish_pubsub(topic, avro, attrs=attrs)

# pull one of the messages we just published and make sure we can
# deserialize it and that it looks as-expected
subscrip = "class-loop"
msg_only = False
max_messages = 1
msgs = gcp_utils.pull_pubsub(
    subscription_name=subscrip, msg_only=msg_only, max_messages=max_messages,
)
msg = msgs[0]
class_dict = fastavro.schemaless_reader(
    io.BytesIO(msg.message.data), main.schema_out
)


# alert_dict = fastavro.schemaless_reader( io.BytesIO( payload ), self.schema )
#             messagebatch.append( { 'topic': msg.topic(),
#                                    'msgoffset': msg.offset(),
#                                    'timestamp': timestamp,
#                                    'msg': alert } )
```

## Containerize the module and deploy to Cloud Run

```bash
SURVEY="elasticc"
TESTID="-testid"
moduledir="classifier"  # assumes we're in the repo's root dir
config="${moduledir}/cloudbuild.yaml"

gcloud builds submit --config="${config}" \
  --substitutions=_SURVEY="${SURVEY}",_TESTID="${TESTID}" \
  "${moduledir}"
```

## Test module on Cloud Run

```bash
# Configure the push subscription
subscrip="elasticc-loop${TESTID}"
topic="elasticc-loop"
topic_project="avid-heading-329016"
url="https://classifier-testid-lipjfwv3dq-uc.a.run.app"
route="/"
runinvoker_svcact="cloud-run-invoker@${GOOGLE_CLOUD_PROJECT}.iam.gserviceaccount.com"

gcloud pubsub subscriptions create "${subscrip}" \
    --topic "${topic}" \
    --topic-project "${topic_project}" \
    --ack-deadline=600 \
    --push-endpoint="${url}${route}" \
    --push-auth-service-account="${runinvoker_svcact}"


gcloud pubsub subscriptions delete "${subscrip}"

# gcloud pubsub subscriptions create ${subscrip} \
#  --topic=${topic} \
#  --push-endpoint=${PUSH_ENDPOINT_URI} \
#  --push-auth-service-account=${SERVICE_ACCOUNT_EMAIL} \
#  --push-auth-token-audience=${OPTIONAL_AUDIENCE_OVERRIDE}

# Only needed for projects created on or before April 8, 2021:
# Grant the Google-managed service account the `iam.serviceAccountTokenCreator` role
# PUBSUB_SERVICE_ACCOUNT="service-${PROJECT_NUMBER}@gcp-sa-pubsub.iam.gserviceaccount.com"
# gcloud projects add-iam-policy-binding ${PROJECT_ID} \
#  --member="serviceAccount:${PUBSUB_SERVICE_ACCOUNT}"\
#  --role='roles/iam.serviceAccountTokenCreator'
```
